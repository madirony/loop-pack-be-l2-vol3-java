# 📋 01. 상세 요구사항 정의서 (Detailed Functional Specification)

## 1. 개요 (Overview)

### 1.1 목표
회원이 옵션이 포함된 상품을 탐색하고, 장바구니에 담아, **재고 동시성 문제** 없이 주문을 완료하는 이커머스 백엔드를 구축한다.
`감성이커머스`의 핵심 가치인 **데이터 정합성**(재고/가격)과 **트랜잭션 원자성**을 최우선으로 고려한다.

### 1.2 범위 (Scope)
* **In-Scope (핵심):**
    * **상품/브랜드:** 브랜드 관리, 상품(옵션) 등록/수정/삭제, 목록/상세 조회.
    * **회원 활동:** 좋아요(찜), 장바구니 담기/수정/삭제/선택주문.
    * **주문 거래:** 주문 생성(재고 선차감), 주문 취소(재고 복구), 주문 내역 조회(스냅샷).
* **Out-Scope (제외):**
    * 회원가입/로그인(헤더 인증 대체), PG 결제, 포인트/쿠폰, 배송, 리뷰.

---

## 2. 유비쿼터스 언어 (Ubiquitous Language)

### 2.1 핵심 용어 정의

| 용어 | 정의 | 비고 |
|------|------|------|
| **회원 (Member)** | 시스템에 등록된 고객. 상품 탐색, 주문 등 모든 거래 활동의 주체. | 사용자(User) 대신 사용 |
| **관리자 (Admin)** | 쇼핑몰 운영자. 브랜드/상품 데이터 관리 권한 보유. | |
| **브랜드 (Brand)** | 상품의 제조사 또는 판매자 단위. | |
| **상품 (Product)** | 판매 대상의 메타 정보(이름, 설명, 기본가격). | |
| **옵션 (Option)** | 실제 판매/재고 관리 단위. 상품의 변형(사이즈, 색상 등). | |
| **재고 (Stock)** | 옵션별 판매 가능 수량. 음수 불가. | |
| **좋아요 (Like)** | 회원이 상품에 표시하는 관심 표현. | |
| **장바구니 (Cart)** | 주문 전 옵션을 임시 보관하는 공간. | |
| **주문 (Order)** | 회원의 구매 의사 확정. 재고 차감 발생 시점. | |
| **주문 항목 (OrderItem)** | 주문에 포함된 개별 옵션 정보. 스냅샷 저장. | |

### 2.2 "Member" 용어 선택 근거

> **왜 "User"가 아닌 "Member"인가?**

| 관점 | 설명 |
|------|------|
| **도메인 명확성** | "User"는 시스템 사용자라는 일반적인 개념. "Member"는 **가입된 고객**이라는 비즈니스 맥락을 담음. |
| **기존 코드 일관성** | 현재 프로젝트의 `Member` 엔티티, `MemberService`, `X-Loopers-LoginId` 헤더와 일치. |
| **책임 명확화** | Member는 주문/장바구니의 **소유자**. Admin은 상품/브랜드의 **관리자**. 역할 경계가 분명해짐. |
| **확장 고려** | 향후 비회원(Guest) 기능 추가 시, Member와 구분이 용이함. |

---

## 3. 액터(Actor) 정의

| 액터 | 설명 | 식별 방법 | 권한 |
|:-----|:-----|:----------|:-----|
| **관리자 (Admin)** | 쇼핑몰 운영자. 브랜드와 상품 데이터를 생성하고 재고를 관리함. | Header `X-Loopers-Ldap` | 모든 데이터 조회/생성/수정/삭제(Soft) |
| **회원 (Member)** | 쇼핑몰 고객. 상품을 탐색하고 주문 트랜잭션을 일으키는 주체. | Header `X-Loopers-LoginId` | 본인의 장바구니, 좋아요, 주문 데이터만 접근 |

---

## 4. 상세 시나리오 (Scenarios)

### 👔 4.1 관리자 시나리오 (Admin Journey)

#### 📖 시나리오 A: 브랜드 입점 및 실패 케이스
1.  **중복 방지:** 관리자 김운영은 '나이키' 브랜드를 등록하려 한다. 하지만 이미 등록된 브랜드명이라 시스템이 거절한다. '나이키 코리아'로 이름을 변경하여 등록에 성공한다.
2.  **정보 수정:** 등록 후 브랜드 로고 이미지가 변경되어 정보를 수정한다.

#### 📖 시나리오 B: 옵션 기반 상품 등록과 재고 설정
1.  **상품 등록:** '러닝화' 상품을 등록한다. 단일 상품이 아니라 **[260, 270, 280]** 사이즈별로 **옵션**을 구성한다.
2.  **가격/재고 설정:** 260 사이즈는 인기 사이즈라 재고를 100개, 가격은 정가로 설정한다. 280 사이즈는 재고를 10개로 설정한다.
3.  **검증:** 실수로 가격을 -100원으로 입력하자, 시스템이 **가격은 0원 이상이어야 합니다**라며 저장을 막는다.

#### 📖 시나리오 C: 브랜드 삭제와 상품의 운명 (Cascade)
1.  **계약 종료:** '아디다스' 브랜드와의 계약이 종료되었다. 김운영은 브랜드를 삭제(Soft Delete)한다.
2.  **자동 숨김:** 브랜드가 삭제되자, 해당 브랜드에 속해 있던 모든 상품들도 회원 리스트에서 **자동으로 숨김(비노출)** 처리된다.

---

### 🛍️ 4.2 회원 시나리오 (Member Journey)

#### 📖 시나리오 D: 취향 저격 상품 탐색 (Search & Filter)
1.  **필터링:** 회원 이쇼핑은 **`브랜드=나이키`**, **`정렬=인기순`** 필터를 적용해 상품을 조회한다.
2.  **상세 진입:** 마음에 드는 '에어맥스' 상품을 발견하고 상세 페이지로 진입한다. 품절된 '230 사이즈' 옵션은 선택할 수 없게 비활성화된 것을 확인한다.

#### 📖 시나리오 E: 좋아요 관리와 멱등성 (Like)
1.  **찜하기(Toggle):** 당장 사기엔 고민되어 **'좋아요(♥)'** 버튼을 누른다. 버튼 색이 채워진다(등록). 다시 누르니 색이 빠진다(취소). 확실히 찜하기 위해 다시 누른다(재등록).
2.  **멱등성 확인:** 네트워크 렉으로 인해 좋아요 버튼을 **다다닥 5번 연속** 클릭했다. 하지만 시스템은 이를 안정적으로 처리하여, 최종적으로 회원이 의도한 상태를 정확히 반영한다. 중복 데이터는 쌓이지 않는다.
3.  **목록 관리:** 마이페이지의 '내 좋아요 목록'에 들어간다. 방금 찜한 '에어맥스'가 최상단에 있다.

#### 📖 시나리오 F: 장바구니 '묵히기'와 가격 변동 (Cart & Stale Data)
1.  **담기:** '러닝화-270'을 장바구니에 담아두고 며칠 동안 잊고 지냈다. 당시 가격은 10만 원이었다.
2.  **가격 변동:** 그사이 관리자가 가격을 12만 원으로 인상했다.
3.  **장바구니 조회:** 3일 뒤 장바구니에 들어온 이쇼핑은, 담을 당시의 10만 원이 아니라 **현재 가격인 12만 원**으로 갱신된 정보를 확인한다.
4.  **품절 알림:** 담아뒀던 '양말'은 그사이 품절되어 **주문 불가능** 상태로 비활성화되어 있다. 이쇼핑은 양말을 삭제하고 러닝화만 남긴다.

#### 📖 시나리오 G: 선택 주문 (Partial Order)
1.  **선택:** 장바구니에 '러닝화', '티셔츠', '모자'가 담겨 있다. 돈이 부족해 이번엔 '러닝화'와 '모자'만 체크박스로 선택한다.
2.  **주문 요청:** 선택한 2개의 상품만으로 주문을 생성한다. '티셔츠'는 주문되지 않고 장바구니에 그대로 남아있다.

#### 📖 시나리오 H: 재고 선점과 동시성 방어 (Concurrency)
1.  **주문 시도:** 마지막 남은 재고 1개를 두고 이쇼핑과 박경쟁이 **동시에** 주문 버튼을 눌렀다.
2.  **선착순 처리:** 시스템은 0.01초라도 먼저 도착한 박경쟁의 주문을 처리하고 재고를 0으로 만든다.
3.  **실패 처리:** 미세하게 늦은 이쇼핑의 요청에 대해 **재고가 부족합니다**라는 에러를 띄우고 결제를 중단한다. 재고는 절대 -1이 되지 않는다.

#### 📖 시나리오 I: 주문 성공과 스냅샷 (Snapshot)
1.  **주문 완료:** 재고 확보에 성공하여 주문이 생성(`COMPLETED`)된다. 장바구니에서 주문한 상품들은 자동으로 사라진다.
2.  **이력 보존:** 한 달 뒤, 해당 상품이 판매 종료(삭제)되었다. 하지만 이쇼핑이 '주문 내역'을 클릭하면, 구매 당시의 상품명, 옵션명, 가격(12만 원) 정보가 삭제되지 않고 정확하게 조회된다.

#### 📖 시나리오 J: 내역 조회와 페이징
1.  **조회:** 이쇼핑은 지난 1년간의 주문 내역을 보고 싶다. 데이터가 많아 시스템은 페이지네이션(20개씩 끊어보기)을 제공하여 쾌적하게 로딩한다.

#### 📖 시나리오 K: 성격 급한 "바로 구매" (Direct Order)
1.  **상세 페이지:** 이쇼핑은 '한정판 운동화'를 발견했다. 장바구니에 담고 이동하는 시간조차 아깝다.
2.  **바로 구매:** 장바구니를 거치지 않고 상세 페이지에서 즉시 '주문하기' 버튼을 누른다.
3.  **처리:** 시스템은 장바구니 테이블을 조회하지 않고, 요청받은 **단일 상품(옵션) 정보만으로 즉시 주문 프로세스**를 태운다.

#### 📖 시나리오 L: 주문 취소와 재고의 귀환 (Cancel & Restore)
1.  **변심:** 주문 완료 후 10분 뒤, 이쇼핑은 색상을 잘못 선택했음을 깨닫고 '주문 취소' 버튼을 누른다.
2.  **재고 복구:** 시스템은 주문 상태를 `CANCELED`로 변경함과 동시에, 차감했던 옵션의 재고를 다시 +1 증가(원상복구) 시킨다.
3.  **확인:** 다시 상품 상세 페이지로 가보니, 방금 취소한 상품의 재고가 돌아와서 **구매 가능** 상태가 된 것을 확인한다.

---

## 5. 도메인별 상세 기능 명세 (Detailed Functional Specifications)

이 섹션은 앞서 정의한 시나리오(A~L)를 기반으로, 시스템이 처리해야 할 구체적인 흐름과 예외 상황을 정의합니다.

### 📦 5.1 상품 (Product) & 브랜드 (Brand)
> **관련 시나리오:** A, B, C, D, K

#### 5.1.1 브랜드 관리 (Admin)
* **기능 정의:** 상품의 기준이 되는 브랜드를 등록, 수정하고 삭제(Soft Delete)한다.
* **정상 흐름 (Normal Flow):**
    1.  관리자가 브랜드명, 로고 이미지 URL, 소개글을 입력하여 등록을 요청한다.
    2.  시스템은 브랜드명의 중복 여부를 확인한다.
    3.  중복이 아니라면 브랜드를 저장하고 등록된 정보를 반환한다.
* **제약 사항 (Constraints):**
    * 브랜드 삭제 시, 해당 브랜드에 속한 모든 상품의 `status`도 `HIDDEN`(숨김) 처리되어야 한다 (**Cascade Soft Delete**). 이 책임은 Brand 도메인 서비스가 담당한다.

#### 5.1.2 상품 및 옵션 등록 (Admin)
* **기능 정의:** 브랜드 하위에 상품을 생성하고, 판매 단위인 '옵션'을 함께 등록한다.
* **책임 정의 (Responsibility):**
    * **Product:** 상품의 메타 정보(이름, 설명, 썸네일) 관리.
    * **Option:** 실질적인 판매 가격(기본가+추가금)과 **물리적 재고(Stock)** 관리.
* **정상 흐름 (Normal Flow):**
    1.  관리자가 상품 정보와 **옵션 리스트** (옵션명, 추가금, 재고수량)를 입력한다.
    2.  시스템은 가격과 재고가 음수가 아닌지 검증한다.
    3.  검증 통과 시 상품과 옵션 데이터를 원자적(Atomic)으로 저장한다.

#### 5.1.3 상품 목록 및 상세 조회 (Member)
* **기능 정의:** 회원이 필터(브랜드)와 정렬 조건을 사용하여 상품을 탐색한다.
* **정상 흐름 (Normal Flow):**
    1.  회원이 `brandId`, `sort` 파라미터를 전송한다.
    2.  시스템은 `deleted_at`이 `NULL`인 상품만 조회한다.
    3.  상세 조회 시, 하위 옵션 목록을 반환한다. 재고가 0인 옵션은 `isSoldOut: true` 상태를 전달한다.
* **제약 사항 (Constraints):**
    * **재고 은닉:** 회원의 조회 응답에는 정확한 재고 수량(Integer)을 노출하지 않고, 구매 가능 여부(Boolean)만 전달한다.

---

### ❤️ 5.2 좋아요 (Like)
> **관련 시나리오:** E

#### 5.2.1 좋아요 토글 (Member)
* **기능 정의:** 회원이 특정 상품에 대해 관심(Like)을 표현하거나 취소한다.
* **정상 흐름 (Normal Flow):**
    1.  회원이 `productId`에 대해 좋아요를 요청한다.
    2.  데이터가 없으면 **등록**, 있으면 삭제(Hard Delete)한다.
* **경계 케이스 (Boundary Case):**
    * **동시성(따닥):** 네트워크 지연으로 좋아요 요청이 동시에 들어올 경우, 서버는 이를 감지하여 최종적으로 **하나의 상태**만 유지해야 한다 (멱등성 보장).
* **삭제 정책:**
    * **Hard Delete** 적용. 좋아요 이력은 보존 가치가 낮고, Soft Delete 시 토글 로직이 복잡해지므로 물리 삭제 채택.

#### 5.2.2 내 좋아요 목록 조회 (Member)
* **기능 정의:** 본인이 찜한 상품 목록을 최신순으로 조회한다.
* **정상 흐름 (Normal Flow):**
    1.  회원이 목록 조회를 요청한다 (`GET /api/v1/likes`).
    2.  삭제된 상품(`deleted_at IS NOT NULL`)은 목록에서 제외한다.

---

### 🛒 5.3 장바구니 (Cart)
> **관련 시나리오:** D, F, G

#### 5.3.1 장바구니 담기 (Member)
* **기능 정의:** 구매 의사가 있는 옵션을 장바구니에 임시 저장한다.
* **정상 흐름 (Normal Flow):**
    1.  회원이 `optionId`와 `quantity`를 전송한다.
    2.  **[Merge Logic]** 이미 동일한 `optionId`가 존재하면 수량을 합산(Update)하고, 없으면 신규 생성(Insert)한다.
* **에러 케이스 (Error Case):**
    * **재고 초과:** 요청 수량이 현재 재고(`Option.stock`)보다 많으면 `400 Bad Request`로 거절한다.

#### 5.3.2 장바구니 조회 (Member)
* **기능 정의:** 장바구니 목록을 조회하며, **실시간 가격과 재고 상태**를 반영한다.
* **정상 흐름 (Normal Flow):**
    1.  회원이 장바구니 조회를 요청한다.
    2.  **[Stale Data 처리]** 장바구니에 담을 때의 가격이 아닌, **현재 시점의 가격**으로 조회한다.
    3.  만약 담아둔 옵션의 재고가 부족해진 경우, `isOrderable: false`로 표시하여 주문을 막는다.

#### 5.3.3 장바구니 수정 및 삭제 (Member)
* **기능 정의:** 장바구니 아이템의 수량을 변경하거나 삭제한다.
* **권한 검증:** 요청한 장바구니 아이템의 소유주가 현재 회원인지 반드시 확인한다.

---

### 🧾 5.4 주문 (Order) - **Core Transaction**
> **관련 시나리오:** G, H, I, K, L

#### 5.4.1 주문 생성 (Member)
* **기능 정의:** 장바구니(또는 바로구매) 상품에 대해 재고를 선점하고 주문을 확정한다.
* **입력 데이터 (Input):**
    * **장바구니 주문:** `cartItemIds` (List) - 장바구니에서 선택한 항목들.
    * **바로 구매:** `optionId`, `quantity` - 상세 페이지에서 직접 주문.
* **트랜잭션 흐름 (Atomic Transaction Flow):**
    1.  **[진입]** 원자적 처리를 시작한다.
    2.  **[재고 검증 및 선차감]**
        * 각 옵션의 재고를 차감한다.
        * **[동시성 제어]** 차감 시점에도 재고가 충분(`stock >= quantity`)해야만 성공으로 처리한다. 실패 시 전체 롤백한다.
        * **[Deadlock 방지]** 여러 상품을 한 번에 주문할 경우, 반드시 **Option ID 오름차순**으로 락(Lock)을 획득하여 데드락을 방지한다.
    3.  **[주문 생성]** `Order` 데이터를 생성한다 (`status: COMPLETED`).
    4.  **[스냅샷 저장]** `OrderItem`에 주문 시점의 **상품명, 옵션명, 가격**을 값(Value)으로 복사하여 저장한다.
    5.  **[장바구니 정리]** 바로구매가 아닌 경우, 주문된 아이템을 장바구니에서 삭제한다.
    6.  **[완료]** 트랜잭션을 확정(Commit)한다.

#### 5.4.2 주문 취소 (Member)
* **기능 정의:** 회원이 주문을 취소하고 재고를 원상복구한다.
* **정책 (Policy):**
    * **가능 조건:** 주문 상태가 `COMPLETED` 인 경우. (추후 배송 상태 추가 시 '배송 전' 조건 적용)
    * **부분 취소:** 지원하지 않음. 전체 주문 취소만 가능.
* **정상 흐름 (Normal Flow):**
    1.  주문 상태를 `CANCELED`로 변경한다.
    2.  **[재고 복구]** `OrderItem`에 기록된 수량만큼 각 옵션의 재고를 다시 증가시킨다.

#### 5.4.3 주문 내역 조회 (Member)
* **기능 정의:** 과거의 주문 이력을 조회한다.
* **정상 흐름 (Normal Flow):**
    1.  시스템은 `OrderItem` 테이블을 조회한다.
    2.  **[불변성 보장]** 현재 상품 정보(`Product`)를 조인하지 않고, 저장된 **스냅샷 데이터**를 반환한다.

---

## 6. 핵심 비즈니스 정책 (Business Policies)

### 6.1 재고 정합성 (Inventory Consistency)
* **절대적 양수:** 재고는 어떤 상황에서도(동시성 이슈 포함) 음수(-)가 될 수 없다.
* **원자성 (All or Nothing):** 주문 상품 중 하나라도 재고가 부족하면 주문 전체가 실패해야 한다.

### 6.2 데이터 불변성 (Snapshot Policy)
* **스냅샷:** 주문 완료 후에는 관리자가 상품 가격이나 이름을 변경하더라도, 이미 완료된 주문 상세 내역(`OrderItem`)은 변경되지 않아야 한다.

### 6.3 데이터 삭제 정책 (Delete Policy)

| 도메인 | 삭제 방식 | 근거 |
|--------|----------|------|
| Brand | Soft Delete | 계약 종료 이력 보존, Cascade 처리 |
| Product | Soft Delete | 주문 내역 참조 가능성 |
| Option | Soft Delete | 주문 내역 참조 가능성 |
| **Like** | **Hard Delete** | 이력 보존 가치 낮음, 토글 로직 단순화 |
| CartItem | Hard Delete | 임시 데이터 |
| Order | 삭제 불가 | 거래 이력 필수 보존 |
| OrderItem | 삭제 불가 | 거래 이력 필수 보존 |

---

## 7. 비기능 요구사항 (Non-Functional Requirements)

| 항목 | 요구사항 |
|------|----------|
| **동시성** | 동일 상품 100건 동시 주문 시 재고 정합성 100% 보장 |
| **가용성** | 주문 API 가용성 99.9% |
| **페이지네이션** | 주문 내역: 20건/페이지 |

